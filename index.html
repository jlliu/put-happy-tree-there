<html>
  <head>
    <title>Leap JavaScript Sample</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="leap.min.js"></script>
    <script src="leap-plugins-0.1.12.min.js"></script>
    <!-- <script src="js-binarysearch.js"></script> -->
    <link rel="stylesheet" type="text/css" href="style.css">
    <script>// JavaScript code goes here
      // Setup Leap loop with frame callback function



// MAIN GAME LOOP
// Called every time the Leap provides a new frame of data
var firstTimestamp;

//keep a queue of 200 frames, in [time,{x:position,y:position}];
var frameQueue = [];
var handInFrame = false;
var gameStarted = true;
var introState =0;
Leap.loop({ frame: function(frame) {
  // console.log(frame);
  if (firstTimestamp == null){
    firstTimestamp = frame.timestamp;
  }
  // console.log(firstTimestamp);
  // console.log("time elapsed");
  // console.log((frame.timestamp-firstTimestamp)/1000);
  var t = (frame.timestamp-firstTimestamp)/1000;
  var hand;
  if (hand = frame.hands[0]){
    handInFrame = true;
    //User begins pointing, change text
    if (introState == 0 && gameStarted){
      introState = 1;
      $(".bobText").html("Try painting a mountain in the horizon. While you're pointing, you can do this by saying:<br> <b>PUT A MOUNTAIN THERE. </b>");
    }
    $("#leapCursor").css({
         left: hand.screenPosition()[0] + 'px',
         top: hand.screenPosition()[1] + 800+ 'px'
    });
    var position = {
      x: hand.screenPosition()[0],
      y: hand.screenPosition()[1] + 800
    };
    if (frameQueue.length < 200){
      frameQueue.push([position,t]);
    } else {
      frameQueue.push([position,t]);
      frameQueue.shift();
    }
    // console.log('frame queue');
    // console.log(frameQueue.length);
     // handHoldDemoOutput.html("[<br/>&nbsp;&nbsp;" + (hand.screenPosition()[0]) +
     //    "        <br/>&nbsp;&nbsp;" + (hand.screenPosition()[1]) +
     //    "        <br/>&nbsp;&nbsp;" + (hand.screenPosition()[2]) + "<br/>]");

      // return handHoldDemoCursor.css({
      //   left: hand.screenPosition()[0] + 'px',
      //   bottom: hand.screenPosition()[1] + 'px'
      // });
    }
  }
}).use('screenPosition', {positioning: 'absolute'});




var recognizer = new webkitSpeechRecognition();
recognizer.lang = "en";
recognizer.continuous = true;
recognizer.interimResults = true;
recognizer.start();
var vocab = ["put","make","paint","mountain","tree","there","here","poetry","but",'that','bear','cloud','iCloud','start'];
//List of tuples (word,time) every time a key word is said, along with time it is said
var speechList = [];
//Takes in speechList and assess whether a given string is already said in it
var containsWord = function(speechList,string){
  var contains = false;
  var containList = speechList.map(function(item){
     if (item[0] == string){
      contains = true;
     }
  });
  console.log(contains);
  return contains;
}

//finds closest or matching value in list, returns the index of that value if found
var binarySearch = function(list,value){
  var low = 0;
  var high = list.length-1;
  var best_index = low;
  while (low <= high){
    mid = low + (high-low)/2;
    if (list[mid] < value){
      low = mid+1;
    } else if(list[mid] > value) {
      high = mid -1;
    } else {
      best_index = mid;
      break
    }
    if (Math.abs(list[mid]-value)< Math.abs(list[best_index]-value)){
      best_index = mid;
    }
  }
  return best_index;

}
//finds closest or matching value in frameQUeue, returns the index of that value if found
var binarySearchFrameQueue = function(list,value){
  var low = 0;
  var high = list.length-1;
  var best_index = low;
  while (low <= high){
    mid = Math.floor(low + (high-low)/2);
    // console.log("mid: "+mid);
    // console.log(list[mid][0]);
    if (list[mid][1] < value){
      low = mid+1;
    } else if(list[mid][1] > value) {
      high = mid -1;
    } else {
      best_index = mid;
      break
    }
    if (Math.abs(list[mid][1]-value)< Math.abs(list[best_index][1]-value)){
      best_index = mid;
    }
  }
  return best_index;

}


//finds closest or matching value in frameQUeue, returns the position object {x: pos, y:pos} at that index
var getPositionFromTime = function(list,value){
  var low = 0;
  var high = list.length-1;
  var best_index = low;
  while (low <= high){
    mid = Math.floor(low + (high-low)/2);
    // console.log("mid: "+mid);
    // console.log(list[mid][0]);
    if (list[mid][1] < value){
      low = mid+1;
    } else if(list[mid][1] > value) {
      high = mid -1;
    } else {
      best_index = mid;
      break
    }
    if (Math.abs(list[mid][1]-value)< Math.abs(list[best_index][1]-value)){
      best_index = mid;
    }
  }
  return list[best_index][0];

}

var horizonLine = 360;
// console.log('binary search test!!!!');
// console.log(binarySearch([1,2,4,7,9,12,14.2],29));
var selectedElement = null;
recognizer.onresult = function(event) {
  //console.log(event);
    var transcript = '';
    var hasFinal = false;
    var time = event.timeStamp;
    //var speechList = [];
    for (var i = event.resultIndex; i < event.results.length; ++i) {
      console.log(event.results[i][0]);
      console.log(time);
      if (event.results[i].isFinal){
        console.log("FINAL");
    //     hasFinal = true;
    //     $('.speech').html(transcript);
    //      //console.log('final:'+event.results[i][0].transcript);


        //Once you receive the Final transcript, interpret the words
        if (containsWord(speechList,"start")&& gameStarted ==false){
          gameStarted = true;
          $(".intro").hide();
          console.log("GAME STARTED");
          $(".speechBar").html("");
        }

        if (gameStarted==true){
                  //This is "making an object mode"
        if (containsWord(speechList,"put") || containsWord(speechList,"but")|| containsWord(speechList,"make") || containsWord(speechList,"paint")  || containsWord(speechList,"poetry")){

          if(introState ==2){
            $(".bobText").hide();
          }
          //Detect that you want to make a tree

          //Create new tree object
           if (containsWord(speechList,"tree") && containsWord(speechList,"there") || containsWord(speechList,"poetry")){
             //Tree dimensions are 124 × 281
              var originalHeight = 281;
              var originalWidth = 124;
              var treeImg = new Image();
              treeImg.className = "tree element";
              treeImg.src = "tree.png";
              
              //Find the time of the "there word"
              var thereTime = speechList["there"];
              var therePosition = getPositionFromTime(frameQueue,thereTime);
              var horizonDist = therePosition.y-horizonLine;
              var scale;
              if (horizonDist > 0){
                scale = .01*horizonDist;
                treeImg.style.left = therePosition.x-originalWidth/2*scale+"px";
              
                treeImg.style.height = originalHeight*scale+"px";
                console.log("therePosition.y+treeImg.style.height: "+therePosition.y+treeImg.style.height);
                treeImg.style.top = therePosition.y-originalHeight*scale+"px";
                console.log("CALCULATED HEIGHT");
                console.log(treeImg.style.height);
                $(".wrapper").append(treeImg);
                console.log("PUT A TREE THERE");
              }

             

           }

           //Create new mountain
           if (containsWord(speechList,"mountain") && containsWord(speechList,"there")){
                               var originalHeight = 287/969*600;
              var originalWidth = 600;
              var mountainImg = new Image();
              mountainImg.className = "mountain element";
              mountainImg.src = "mountain.png";
              
              //Find the time of the "there word"
              var thereTime = speechList["there"];
              var therePosition = getPositionFromTime(frameQueue,thereTime);

              mountainImg.style.left = therePosition.x-originalWidth/2+"px";
              $(".wrapper").append(mountainImg);
              console.log("PUT A MOUNTAIN THERE");
              //After user intiaially has put a mountain, change state
              if (introState == 1){
                introState = 2;
                $(".bobText").html("Now, try making a <b>CLOUD</b> or a <b>TREE</b> in a similar way. Have fun!");
              }
              

           }

            //Create new cloud
           if (containsWord(speechList,"cloud") && (containsWord(speechList,"there")||containsWord(speechList,"bear"))){
              var originalHeight = 191;
              var originalWidth = 562;
              console.log("DOING THE CLOUD");
              var cloudImg = new Image();
              cloudImg.className = "cloud element";
              cloudImg.src = "cloud.png";
              
              //Find the time of the "there word"
              var thereTime = speechList["there"];
              var therePosition = getPositionFromTime(frameQueue,thereTime);

              var horizonDist = horizonLine-therePosition.y;
              var scale;
              if (horizonDist > 0){
                scale = .01*horizonDist;
                cloudImg.style.left = therePosition.x-originalWidth/4*scale+"px";
                cloudImg.style.height = originalHeight/2*scale+"px";
                cloudImg.style.top = therePosition.y-originalHeight/4*scale+"px";
                $(".wrapper").append(cloudImg);
              }

             

           }


           //"Put that there" - moving an existing object from one place to another
           //Check that you say "that" and "there", and "that before there"
           console.log("contains word that:"+containsWord(speechList,"that"));
           console.log("contains word there:"+containsWord(speechList,"there"));

           console.log(speechList.indexOf("that"));
           console.log(speechList.indexOf("there"));
           // if (containsWord(speechList,"that") && containsWord(speechList,"there")){

        }
        if (containsWord(speechList,"there")){
              console.log("entering PUT THAT THERE CODE");

              if (selectedElement != null){
                //Create a copy of selected element
                console.log("SELECTED ELEMENT NOT NULL");
                //Element is a tree
                if($(selectedElement).hasClass("tree")){
                    console.log("GONNA MOVE THIS TREE!");
                    var originalHeight = 281;
                     var originalWidth = 124;
                    var treeImg = new Image();
                    treeImg.className = "tree element";
                    treeImg.src = "tree.png";
                    
                    //Find the time of the "there word"
                    var thereTime = speechList["there"];
                    console.log(frameQueue);
                    // var thereIndex = binarySearchFrameQueue(frameQueue,thereTime);
                    // console.log("thereIndex: "+thereIndex);
                    var therePosition = getPositionFromTime(frameQueue,thereTime);
                    var horizonDist = therePosition.y-horizonLine;
                    var scale;
                    if (horizonDist > 0){
                      scale = .01*horizonDist;
                      treeImg.style.left = therePosition.x-originalWidth/2*scale+"px"; 
                      treeImg.style.height = originalHeight*scale+"px";
                      treeImg.style.top = therePosition.y-originalHeight*scale+"px";
                      $(".wrapper").append(treeImg);
                      console.log("PUT A TREE THERE");
                    }

                }
                if ($(selectedElement).hasClass("mountain")){
                                var originalHeight = 287/969*600;
              var originalWidth = 600;
                  var mountainImg = new Image();
                  mountainImg.className = "mountain element";
                  mountainImg.src = "mountain.png";
                  
                  //Find the time of the "there word"
                  var thereTime = speechList["there"];
                  console.log(frameQueue);
                  // var thereIndex = binarySearchFrameQueue(frameQueue,thereTime);
                  //console.log("thereIndex: "+thereIndex);
                  var therePosition = getPositionFromTime(frameQueue,thereTime);


                  mountainImg.style.left = therePosition.x-originalWidth/2+"px";
                  //treeImg.style.top = therePosition.y-100+"px";
                  $(".wrapper").append(mountainImg);
                  console.log("PUT A MOUNTAIN THERE");
                }

                 //Create new cloud
           if ($(selectedElement).hasClass("cloud")){
              var originalHeight = 191;
              var originalWidth = 562;
              console.log("DOING THE CLOUD");
              var cloudImg = new Image();
              cloudImg.className = "cloud element";
              cloudImg.src = "cloud.png";
              
              //Find the time of the "there word"
              var thereTime = speechList["there"];
              var therePosition = getPositionFromTime(frameQueue,thereTime);

              var horizonDist = horizonLine-therePosition.y;
              var scale;
              if (horizonDist > 0){
                scale = .01*horizonDist;
                cloudImg.style.left = therePosition.x-originalWidth/4*scale+"px";
              
                cloudImg.style.height = originalHeight/2*scale+"px";
                cloudImg.style.top = therePosition.y-originalHeight/4*scale+"px";
                $(".wrapper").append(cloudImg);
                console.log("PUT A CLOUD THERE");
              }

             

           }
                $(selectedElement).hide();
                selectedElement = null;
              }
           }
        }


        speechList = [];
       }else {
    //     console.log('individual word:'+event.results[i][0].transcript);
    //     transcript += event.results[i][0].transcript;
    //     $('.speech').html(transcript);
        console.log("not final");
        //Record the first instances of words that are said, if words are
        //mountain, tree, put, make

        var thisPhrase = event.results[i][0].transcript;
        var phraseWords = thisPhrase.split(' ');
        console.log(phraseWords);

        //Iterate through each word said
        for (var j = 0; j<phraseWords.length; j++){
          console.log('iterating through phraseWords');
          word = phraseWords[j].toLowerCase();
          //Check if there is a match


          if (vocab.indexOf(word) >= 0){
            console.log("word is recognized");
            console.log(containsWord(speechList,word));
            //This is the first instance of the word in the given context
            if (!containsWord(speechList,word)){
              console.log("adding new word to speech list");
               speechList.push([word,time]);

              //SPECIAL CASE: word we said is "that", in this case we want to instantly highlight
              if( word == "that"){
                console.log("SAYING THAT");
                //Highlight the element that is said during "that"
                //Get the time of that, and get position from framequeue at that time
                // var thatIndex = binarySearchFrameQueue(frameQueue,time);

                //That position is position object {x:pos,y:pos}
                var thatPosition = getPositionFromTime(frameQueue,time);
                //Find element within those coordinates

                //Iterate through existing painting elements
                var elements = $(".element");
                console.log("elements");
                console.log(elements);

                $(elements).each(function(index){
                  var thisElement = elements[index];
                  var divRect = $(thisElement).offset();
                  console.log($(thisElement).offset());
                  if(thatPosition.x>= divRect.left && thatPosition.x <= divRect.left+$(thisElement).width() &&
                      thatPosition.y >= divRect.top && thatPosition.y <= divRect.top+$(thisElement).height() ){
                    selectedElement = thisElement;
                  }
                });
                $(selectedElement).addClass("highlighted");
              }
            }
            
          }
        }
        // speechList.push((thisPhrase,time));
       }
    }
    console.log("THIS IS SPEECHLIST");
    console.log(speechList);
    if (event.results.length > 0) {
        // console.log(event);
        //console.log(event.results[event.results.length-1]);
        // var result = event.results[event.results.length-1];
        // console.log(result);
        // if(result.isFinal) {
        //     console.log(result[0].transcript);
        // }
    }  
      var interim_transcript = '';
    var final_transcript='';
    for (var i = event.resultIndex; i < event.results.length; ++i) {
      if (event.results[i].isFinal) {
        final_transcript += event.results[i][0].transcript;
        //$(".recentSpeech").html(final_transcript);
        if(gameStarted==true){
          $(".speechBar").html("<b>What we think you said:<br></b>"+final_transcript);
          console.log("FINAL TRANSCRIPT: "+ final_transcript);
        }
      
      } else {
        interim_transcript += event.results[i][0].transcript;
      }
    }
    // final_transcript = final_transcript;
    // // final_span.innerHTML = linebreak(final_transcript);
    // console.log(final_transcript);
    // console.log(interim_transcript);
    // // interim_span.innerHTML = linebreak(interim_transcript);
};




// $(document).ready(function(){
  
//   if (handInFrame == true){
//     if (introState == )
//   }



// });


    </script>

  </head>
    <body >
<!--   <body onload="checkLibrary()"> -->
    <div id="leapCursor"></div>
    <div class="info">
       <img class="bob" src="bob.png">
       <div class="bobText">Welcome! I'm Bob and this is your canvas. The sky and ground are already painted for you. <b>Use your hand to point anywhere</b> on the screen to begin adding more to your painting! </div>
    </div>
   
    <div class="wrapper">
      <img class="sky" src="sky.png">
      <!-- <img class="mtn" src="mountain.png"> -->
      <img class="ground" src="ground.png">
      <!-- <img class="tree" src="tree.png"> -->
      <img class="intro" src="intro.png">
    </div>
    <!-- <h1>Gestural Landscape painting maker</h1> -->
    <div class="speechBar"></div>
<!--     <div id="main">
      <div class="speech"></div>
      <h3>Frame data:</h3>
      <div id="frameData"></div>
      <div style="clear:both;"></div>
      <h3>Hand data:</h3>
      <div id="handData"></div>
      <div style="clear:both;"></div>
      <h3>Finger data:</h3>
      <div id="pointableData"></div>
      <div style="clear:both;"></div>
    </div> -->
  </body>
</html>